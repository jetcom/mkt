<!-- Question Modal -->
    <div id="question-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col fade-in">
            <div class="px-6 py-4 border-b border-gray-100 dark:border-slate-700 bg-gray-50 dark:bg-slate-900">
                <div class="flex justify-between items-center">
                    <h3 id="modal-title" class="text-lg font-semibold text-gray-900 dark:text-white">New Question</h3>
                    <button onclick="closeModal()" class="w-8 h-8 rounded-lg hover:bg-gray-200 dark:hover:bg-slate-700 flex items-center justify-center transition-colors">
                        <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-slate-400"></i>
                    </button>
                </div>
                <!-- Block Variant Tabs (shown when question is in a block) -->
                <div id="block-tabs-container" class="hidden mt-3">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-2">
                            <i data-lucide="layers" class="w-4 h-4 text-orange-500"></i>
                            <span id="block-tabs-label" class="text-xs font-medium text-orange-600 dark:text-orange-400"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="addBlockVariant()" class="text-xs px-2 py-1 rounded-lg bg-orange-100 dark:bg-orange-900/40 text-orange-700 dark:text-orange-300 hover:bg-orange-200 dark:hover:bg-orange-900/60 flex items-center gap-1">
                                <i data-lucide="plus" class="w-3 h-3"></i> Add Variant
                            </button>
                            <div class="relative" id="ai-variant-dropdown">
                                <button onclick="toggleAiVariantMenu()" class="text-xs px-2 py-1 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:from-purple-600 hover:to-pink-600 flex items-center gap-1">
                                    <i data-lucide="sparkles" class="w-3 h-3"></i> AI Variant
                                    <i data-lucide="chevron-down" class="w-3 h-3"></i>
                                </button>
                                <div id="ai-variant-menu" class="hidden absolute right-0 mt-1 w-48 bg-white dark:bg-slate-800 rounded-lg shadow-lg border border-gray-200 dark:border-slate-600 py-1 z-50">
                                    <button onclick="aiBlockVariant('same')" class="w-full text-left px-3 py-2 text-xs text-gray-700 dark:text-slate-200 hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center gap-2">
                                        <i data-lucide="copy" class="w-3 h-3 text-purple-500"></i> Same type (reword)
                                    </button>
                                    <div class="border-t border-gray-100 dark:border-slate-700 my-1"></div>
                                    <button onclick="aiBlockVariant('multipleChoice')" class="w-full text-left px-3 py-2 text-xs text-gray-700 dark:text-slate-200 hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center gap-2">
                                        <i data-lucide="list" class="w-3 h-3 text-sky-500"></i> As Multiple Choice
                                    </button>
                                    <button onclick="aiBlockVariant('trueFalse')" class="w-full text-left px-3 py-2 text-xs text-gray-700 dark:text-slate-200 hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center gap-2">
                                        <i data-lucide="check-circle" class="w-3 h-3 text-emerald-500"></i> As True/False
                                    </button>
                                    <button onclick="aiBlockVariant('shortAnswer')" class="w-full text-left px-3 py-2 text-xs text-gray-700 dark:text-slate-200 hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center gap-2">
                                        <i data-lucide="minus" class="w-3 h-3 text-amber-500"></i> As Short Answer
                                    </button>
                                    <button onclick="aiBlockVariant('longAnswer')" class="w-full text-left px-3 py-2 text-xs text-gray-700 dark:text-slate-200 hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center gap-2">
                                        <i data-lucide="align-left" class="w-3 h-3 text-rose-500"></i> As Long Answer
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="block-tabs" class="flex gap-1 overflow-x-auto pb-1"></div>
                </div>
                <!-- Linked Questions Tabs (shown when question has links) -->
                <div id="linked-tabs" class="hidden mt-3 flex gap-1 overflow-x-auto pb-1"></div>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div class="min-w-0">
                        <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Question Bank</label>
                        <div class="flex gap-2">
                            <select id="q-bank" class="input-modern flex-1 px-3 py-2 rounded-lg min-w-0 truncate">
                                <option value="">Select a bank...</option>
                            </select>
                            <button type="button" onclick="showNewBankForm()" class="px-3 py-2 bg-emerald-100 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-300 rounded-lg hover:bg-emerald-200 dark:hover:bg-emerald-800/50" title="Create new bank">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <!-- Inline new bank form -->
                        <div id="new-bank-form" class="hidden mt-2 p-3 bg-gray-50 dark:bg-slate-700/50 rounded-lg space-y-2">
                            <div class="flex gap-2">
                                <select id="new-bank-course" class="input-modern flex-1 px-3 py-2 rounded-lg text-sm">
                                    <option value="">Select course...</option>
                                </select>
                                <button type="button" onclick="showNewCourseForm()" class="px-2 py-2 bg-sky-100 dark:bg-sky-900/50 text-sky-700 dark:text-sky-300 rounded-lg hover:bg-sky-200 dark:hover:bg-sky-800/50 text-sm" title="Create new course">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <!-- Inline new course form -->
                            <div id="new-course-form" class="hidden p-2 bg-white dark:bg-slate-800 rounded-lg border border-sky-200 dark:border-sky-700 space-y-2">
                                <input type="text" id="new-course-code" placeholder="Course code (e.g., CSCI320)" class="input-modern w-full px-3 py-2 rounded-lg text-sm">
                                <input type="text" id="new-course-name" placeholder="Course name (optional)" class="input-modern w-full px-3 py-2 rounded-lg text-sm">
                                <div class="flex gap-2">
                                    <button type="button" onclick="createNewCourse()" class="flex-1 px-3 py-1.5 text-sm bg-sky-500 text-white rounded-lg hover:bg-sky-600">Create Course</button>
                                    <button type="button" onclick="hideNewCourseForm()" class="px-3 py-1.5 text-sm text-gray-600 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-600 rounded-lg">Cancel</button>
                                </div>
                            </div>
                            <input type="text" id="new-bank-name" placeholder="Bank name (e.g., Midterm, Final)" class="input-modern w-full px-3 py-2 rounded-lg text-sm">
                            <div class="flex gap-2">
                                <button type="button" onclick="createNewBank()" class="flex-1 px-3 py-1.5 text-sm bg-emerald-500 text-white rounded-lg hover:bg-emerald-600">Create Bank</button>
                                <button type="button" onclick="hideNewBankForm()" class="px-3 py-1.5 text-sm text-gray-600 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-600 rounded-lg">Cancel</button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Question Type</label>
                        <select id="q-type" onchange="updateAnswerFields()" class="input-modern w-full px-3 py-2 rounded-lg">
                            <option value="multipleChoice">Multiple Choice</option>
                            <option value="trueFalse">True/False</option>
                            <option value="shortAnswer">Short Answer</option>
                            <option value="longAnswer">Long Answer</option>
                        </select>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-medium text-gray-700 dark:text-slate-300">Question Text</label>
                        <div class="flex gap-2">
                            <button type="button" onclick="triggerImageUpload()" class="text-xs px-2 py-1 rounded-lg bg-emerald-100 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-300 hover:bg-emerald-200 flex items-center gap-1">
                                <i data-lucide="image" class="w-3 h-3"></i>Add Image
                            </button>
                            <button type="button" onclick="togglePreview()" id="preview-toggle" class="text-xs px-2 py-1 rounded-lg bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 hover:bg-gray-200 flex items-center gap-1">
                                <i data-lucide="eye" class="w-3 h-3"></i>Preview
                            </button>
                        </div>
                    </div>
                    <!-- Hidden file input for image upload -->
                    <input type="file" id="image-upload-input" accept="image/jpeg,image/png,image/gif,image/webp" class="hidden" onchange="handleImageUpload(event)">
                    <!-- Image upload status/gallery -->
                    <div id="question-images" class="hidden mb-2 p-2 bg-gray-50 dark:bg-slate-700/50 rounded-lg">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-medium text-gray-600 dark:text-slate-400">Uploaded Images</span>
                            <span id="image-upload-status" class="text-xs text-gray-400"></span>
                        </div>
                        <div id="question-images-list" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3" id="editor-wrapper">
                        <div id="editor-col">
                            <div id="editor-container" class="monaco-container"></div>
                        </div>
                        <div id="preview-col" class="hidden">
                            <div id="markdown-preview" class="h-[250px] border-2 border-gray-200 dark:border-slate-600 rounded-lg p-3 overflow-y-auto bg-white dark:bg-slate-900 text-sm text-gray-800 dark:text-slate-200"></div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 dark:text-slate-500 mt-1">Supports Markdown: **bold**, *italic*, `code`, ```code blocks```, ![alt](image-url)</p>
                </div>

                <div id="answer-fields"></div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Points</label>
                        <input type="number" id="q-points" value="2" min="0" step="0.5" class="input-modern w-full px-3 py-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Difficulty</label>
                        <select id="q-difficulty" class="input-modern w-full px-3 py-2 rounded-lg">
                            <option value="easy">Easy</option>
                            <option value="medium" selected>Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Tags</label>
                        <input type="text" id="q-tags" placeholder="Week 1, SQL, etc." class="input-modern w-full px-3 py-2 rounded-lg">
                    </div>
                </div>

                <!-- Block Info (shown when question is part of a block - simplified, tabs are in header) -->
                <div id="block-section" class="hidden">
                    <div class="bg-orange-50 dark:bg-orange-900/30 rounded-lg p-3 text-sm border border-orange-200 dark:border-orange-800">
                        <p class="text-orange-700 dark:text-orange-300 text-xs flex items-center gap-2">
                            <i data-lucide="info" class="w-3 h-3"></i>
                            <span id="block-max-display"></span>
                        </p>
                    </div>
                </div>

                <!-- Create Block option (shown when question is NOT in a block) -->
                <div id="create-block-section" class="hidden">
                    <div class="bg-gray-50 dark:bg-slate-700/50 rounded-lg p-3 border border-gray-200 dark:border-slate-600">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i data-lucide="git-branch" class="w-4 h-4 text-gray-400"></i>
                                <span class="text-sm text-gray-600 dark:text-slate-300">Create variants of this question</span>
                            </div>
                            <button type="button" onclick="createBlockFromQuestion()" class="text-xs px-3 py-1.5 rounded-lg bg-orange-100 dark:bg-orange-900/40 text-orange-700 dark:text-orange-300 hover:bg-orange-200 dark:hover:bg-orange-900/60 flex items-center gap-1">
                                <i data-lucide="plus" class="w-3 h-3"></i> Create Block
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 dark:text-slate-500 mt-2">Blocks let you create multiple versions of a question. When generating exams, one variant is randomly selected per block.</p>
                    </div>
                </div>

                <!-- Sync button for non-canonical questions -->
                <div id="sync-section" class="hidden border-t border-gray-100 dark:border-slate-700 pt-4 mt-2">
                    <button type="button" onclick="syncFromCanonical()" id="sync-btn" class="text-sm text-sky-600 hover:text-sky-700 dark:text-sky-400 font-medium flex items-center gap-2">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        Sync from canonical version
                    </button>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-100 dark:border-slate-700 flex justify-between bg-gray-50 dark:bg-slate-900">
                <button id="delete-btn" onclick="deleteQuestion()" class="px-4 py-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg font-medium transition-colors hidden">
                    <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>Delete
                </button>
                <div class="flex gap-3 ml-auto">
                    <button onclick="closeModal()" class="px-5 py-2 text-gray-600 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg font-medium transition-colors">Cancel</button>
                    <button onclick="saveQuestion()" class="btn-primary px-6 py-2 text-white rounded-lg font-medium">Save Question</button>
                </div>
            </div>
        </div>
    </div>
